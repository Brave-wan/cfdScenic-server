<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.htkj.cfdScenic.app.dao.VisitorsOrderDao">

	<resultMap type="com.htkj.cfdScenic.app.model.VisitorsOrder" id="baseResultMap">
		<id property="id" column="id"/>
		<result property="name" column="name"/>
		<result property="orderDescribe" column="order_describe"/>
		<result property="price" column="price"/>
		<result property="startValid" column="start_valid"/>
		<result property="endValid" column="end_valid"/>
		<result property="quantity" column="quantity"/>
		<result property="payWay" column="pay_way"/>
		<result property="payState" column="pay_state"/>
		<result property="orderState" column="order_state"/>
		<result property="createTime" column="create_time"/>
		<result property="payTime" column="pay_time"/>
		<result property="refundTime" column="refund_time"/>
		<result property="userId" column="user_id"/>
		<result property="realPrice" column="real_price"/>
		<result property="orderCode" column="order_code"/>
		<result property="isComment" column="is_comment"/>
		<result property="visitorsId" column="visitors_id"/>
		<result property="type" column="type"/>
		<result property="integraPrice" column="integra_price"/>
		<result property="addressId" column="address_id"/>
		<result property="isMention" column="is_mention"/>
		<result property="isDelete" column="is_delete"/>
		<result property="isInvoice" column="is_invoice"/>
		<result property="invoiceState" column="invoice_state"/>
	</resultMap>

	<!-- 未使用门票列表分页 -->
	<select id="pageVisitorsOrderListWei" parameterType="map" resultType="map">
		SELECT 
			vo.*,
			v.name as v_name,
			cu.user_name
		FROM 
			visitors_order vo left join visitors v on vo.visitors_id = v.id left join consumer_user cu on vo.user_id = cu.id 
			<where>
				(order_state=1 or order_state=2 or order_state=5 or order_state=6 or order_state=8)
				<if test="@Ognl@isNotBlank(orderCode)">
				and order_code like CONCAT('%',#{orderCode},'%')
				</if>
			</where>
		ORDER BY create_time DESC
	</select>
	<select id="pageVisitorsOrderListWei_count" parameterType="map" resultType="int">
		SELECT COUNT(1) FROM visitors_order
			<where>
				(order_state=1 or order_state=2 or order_state=5 or order_state=6 or order_state=8)
				<if test="@Ognl@isNotBlank(orderCode)">
				and order_code like CONCAT('%',#{orderCode},'%')
				</if>
			</where>
		ORDER BY create_time DESC
	</select>
	
	<!-- 已使用门票列表分页 -->
	<select id="pageVisitorsOrderListYi" parameterType="map" resultType="map">
		SELECT 
			vo.*,
			v.name as v_name,
			cu.user_name
		FROM 
			visitors_order vo left join visitors v on vo.visitors_id = v.id left join consumer_user cu on vo.user_id = cu.id 
			<where>
				(order_state=3 or order_state=4 or order_state=7 or order_state=9)
				<if test="@Ognl@isNotBlank(orderCode)">
				and order_code like CONCAT('%',#{orderCode},'%')
				</if>
			</where>
		ORDER BY create_time DESC
	</select>
	<select id="pageVisitorsOrderListYi_count" parameterType="map" resultType="int">
		SELECT COUNT(1) FROM visitors_order
			<where>
				(order_state=3 or order_state=4 or order_state=7 or order_state=9)
				<if test="@Ognl@isNotBlank(orderCode)">
				and order_code like CONCAT('%',#{orderCode},'%')
				</if>
			</where>
		ORDER BY create_time DESC
	</select>
	
	<select id="selectByPrimaryKey" parameterType="Long" resultType="map">
		SELECT 
			vo.*,
			v.name as v_name,
			cu.user_name
		FROM 
			visitors_order vo left join visitors v on vo.visitors_id = v.id left join consumer_user cu on vo.user_id = cu.id
		WHERE vo.id = #{id}
	</select>
	
	<delete id="deleteByPrimaryKey" parameterType="Long">
		DELETE FROM visitors_order WHERE id = #{id}
	</delete>
	
	<update id="updateByOrderCode" parameterType="com.htkj.cfdScenic.app.model.VisitorsOrder">
		UPDATE visitors_order
			<set>
				<if test="name != null">
				name = #{name},
				</if>
				<if test="orderDescribe != null">
				order_describe = #{orderDescribe},
				</if>
				<if test="price != null">
				price = #{price},
				</if>
				<if test="startValid != null">
				start_valid = #{startValid},
				</if>
				<if test="endValid != null">
				end_valid = #{endValid},
				</if>
				<if test="quantity != null">
				quantity = #{quantity},
				</if>
				<if test="payWay != null">
				pay_way = #{payWay},
				</if>
				<if test="payState != null">
				pay_state = #{payState},
				</if>
				<if test="orderState != null">
				order_state = #{orderState},
				</if>
				<if test="createTime != null">
				create_time = #{createTime},
				</if>
				<if test="payTime != null">
				pay_time = #{payTime},
				</if>
				<if test="refundTime != null">
				refund_time = #{refundTime},
				</if>
				<if test="userId != null">
				user_id = #{userId},
				</if>
				<if test="realPrice != null">
				real_price = #{realPrice},
				</if>
				<if test="isComment != null">
				is_comment = #{isComment},
				</if>
				<if test="visitorsId != null">
				visitors_id = #{visitorsId},
				</if>
				<if test="type != null">
				type = #{type},
				</if>
				<if test="integraPrice != null">
				integra_price = #{integraPrice},
				</if>
				<if test="addressId != null">
				address_id = #{addressId},
				</if>
				<if test="isMention != null">
				is_mention = #{isMention},
				</if>
				<if test="isDelete != null">
				is_delete = #{isDelete},
				</if>
				<if test="isInvoice != null">
				is_invoice = #{isInvoice},
				</if>
				<if test="invoiceState != null">
				invoice_state = #{invoiceState},
				</if>
			</set>
		WHERE order_code = #{orderCode}
	</update>
	
	
	<insert id="insertMessage" parameterType="com.htkj.cfdScenic.app.model.VisitorsOrder">
		insert into visitors_order 
		(id, name, 
		order_describe,price,
		start_valid,end_valid,
		quantity,pay_way,
		pay_state,order_state,
		create_time,user_id,
		real_price,order_code,integra_price,
		is_comment,visitors_id,address_id,is_mention,type) 
		values 
		(#{id,jdbcType=BIGINT}, #{name,jdbcType=VARCHAR},
		#{orderDescribe,jdbcType=VARCHAR},#{price},
		DATE_FORMAT(#{startValid},'%Y-%c-%d'),DATE_FORMAT(#{endValid},'%Y-%c-%d'),
		#{quantity,jdbcType=INTEGER},#{payWay,jdbcType=INTEGER},
		#{payState,jdbcType=INTEGER}, #{orderState,jdbcType=INTEGER},
		now(), #{userId,jdbcType=BIGINT},
		#{realPrice}, #{orderCode,jdbcType=VARCHAR},#{integraPrice,jdbcType=INTEGER},
		#{isComment,jdbcType=INTEGER},#{visitorsId,jdbcType=BIGINT},#{addressId,jdbcType=BIGINT},#{isMention},#{type})
	</insert>
	
	<insert id="insertMessage2" parameterType="com.htkj.cfdScenic.app.model.VisitorsOrder">
		insert into visitors_order 
		(id,pay_time) 
		values 
		(#{id,jdbcType=BIGINT},DATE_FORMAT(#{payTime},'%Y-%c-%d %h:%i:%s'))
		
	</insert>
	<select id="selectVisitorsOrder" parameterType="long" resultType="map">
		select
			id,
			name,
			integra_price,
			price,
			real_price,
		from
			visitors_order
		where
			id = #{id,jdbcType=NUMERIC}
	</select>
	<select id="selectMyAllVisitorsOrder" parameterType="long" resultType="map">
		select
			vo.id,
			DATE_FORMAT(vo.start_valid,'%Y-%m-%d %h:%i:%s') as start_valid,
			DATE_FORMAT(vo.end_valid,'%Y-%m-%d %h:%i:%s') as end_valid,
			v.head_img,
			vo.integra_price
		from 
			visitors_order vo join visitors v on vo.visitors_id = v.id
		where
			vo.user_id = #{userId}
	</select>
	
	<update id="updateStateMessage" parameterType="map">
		update visitors_order set pay_time = #{payTime},order_state=5 where user_id=#{userId}
	</update>
	
	<update id="updatePayStatus" parameterType="map">
		update visitors_order set pay_time = now(),pay_way=#{payWay},pay_state=1,order_state=2 where order_code=#{orderCode}
	</update>
	
	
	<select id="selectVisitorsOrderDetail" parameterType="long" resultType="map">
		select
			vo.id,
			DATE_FORMAT(vo.start_valid,'%Y-%m-%d %h:%i:%s') as start_valid,
			DATE_FORMAT(vo.end_valid,'%Y-%m-%d %h:%i:%s') as start_valid,
			v.head_img,
			v.goods_type,
			vo.integra_price,
			vo.order_code,
			DATE_FORMAT(vo.create_time,'%Y-%m-%d %h:%i:%s') as create_time,
			DATE_FORMAT(vo.pay_time,'%Y-%m-%d %h:%i:%s') as pay_time,
			vo.pay_way,
			vo.real_price,
			ud.user_name,
			ud.telphone,
			ud.detail_address
		from 
			visitors_order vo left join visitors v on vo.visitors_id = v.id left join user_address ud on vo.address_id = ud.id
		where
			vo.id = #{id}
	</select>
	<select id="getPersonCount" parameterType="map" resultType="int">
		select
			sum(quantity)
		from
			visitors_order
		where 
			visitors_id = #{id}  and pay_state=1 and order_state=3
	</select>
	
	
	<select id="selectOrderList" resultType="map" parameterType="map">
		select 
		o.id,
		o.name,
		o.order_describe,
		o.integra_price,
		DATE_FORMAT(o.start_valid,'%Y-%c-%d %h:%i:%s') as start_valid, 
		DATE_FORMAT(o.end_valid,'%Y-%c-%d %h:%i:%s') as end_valid,
		o.order_state,
		v.head_img,
		v.goods_type 
		from 
		visitors_order o join visitors v on o.visitors_id=v.id 
		where 
		o.user_id=#{userId} and o.type = 1 order by o.create_time
	</select>
	
	<select id="selectOrderList_count" resultType="int" parameterType="map">
		select 
		count(1) 
		from 
		visitors_order o join visitors v on o.visitors_id=v.id 
		where 
		o.user_id=#{userId} and o.type = 1 order by o.create_time
	</select>
	
	<select id="selectById" resultType="map" parameterType="int">
		select 
		o.id,
		o.name,
		o.order_describe,
		o.integra_price,
		DATE_FORMAT(o.start_valid,'%Y-%c-%d %h:%i:%s') as start_valid, 
		DATE_FORMAT(o.end_valid,'%Y-%c-%d %h:%i:%s') as end_valid,
		o.order_state,
		o.order_code,
		o.address_id,
		v.head_img,DATE_FORMAT(o.create_time,'%Y-%c-%d %h:%i:%s') as create_time, DATE_FORMAT(o.pay_time,'%Y-%c-%d %h:%i:%s') as pay_time,o.is_mention,o.real_price
		from 
		visitors_order o join visitors v on o.visitors_id=v.id 
		where 
		o.id=#{id} and o.type = 1 order by o.create_time
	</select>
	<select id="getVisitorsOrderById" parameterType="long" resultType="map">
		select
			vo.id,
			vo.name,
			vo.order_describe,
			vo.price,
			DATE_FORMAT(vo.start_valid,'%Y-%m-%d') as start_valid,
			DATE_FORMAT(vo.end_valid,'%Y-%m-%d') as end_valid,
			sum(vo.quantity) as quantity,
			vo.real_price,
			vo.order_code,
			ua.balance
		from
			visitors_order vo left join user_account ua on vo.user_id = ua.user_id
		where
			vo.order_code = #{orderCode} limit 1
	</select>
	<select id="findOrderByOrderId" parameterType="long" resultType="map">
		select
			id,
			name,
			DATE_FORMAT(end_valid,'%Y-%m-%d') as end_valid,
			order_code
		from
			visitors_order
		where
			order_code = #{orderCode}
	</select>
</mapper>