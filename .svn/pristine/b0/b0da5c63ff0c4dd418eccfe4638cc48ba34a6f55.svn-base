<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.htkj.cfdScenic.app.dao.VisitorsOrderDao">

	<insert id="insertMessage" parameterType="com.htkj.cfdScenic.app.model.VisitorsOrder">
		insert into visitors_order 
		(id, name, 
		order_describe,price,
		start_valid,end_valid,
		quantity,pay_way,
		pay_state,order_state,
		create_time,pay_time,
		refund_time,user_id,
		real_price,order_code,integra_price,
		is_comment,visitors_id,address_id,is_mention,type) 
		values 
		(#{id,jdbcType=BIGINT}, #{name,jdbcType=VARCHAR},
		#{orderDescribe,jdbcType=VARCHAR},#{price},
		DATE_FORMAT(#{startValid},'%Y-%c-%d'),DATE_FORMAT(#{endValid},'%Y-%c-%d'),
		#{quantity,jdbcType=INTEGER},#{payWay,jdbcType=INTEGER},
		#{payState,jdbcType=INTEGER}, #{orderState,jdbcType=INTEGER},
		now(),DATE_FORMAT(#{payTime},'%Y-%c-%d %h:%i:%s'),
		DATE_FORMAT(#{refundTime},'%Y-%c-%d %h:%i:%s'), #{userId,jdbcType=BIGINT},
		#{realPrice}, #{orderCode,jdbcType=VARCHAR},#{integraPrice,jdbcType=INTEGER},
		#{isComment,jdbcType=INTEGER},#{visitorsId,jdbcType=BIGINT},#{addressId,jdbcType=BIGINT},#{isMention},#{type})
	</insert>
	
	<insert id="insertMessage2" parameterType="com.htkj.cfdScenic.app.model.VisitorsOrder">
		insert into visitors_order 
		(id,pay_time) 
		values 
		(#{id,jdbcType=BIGINT},DATE_FORMAT(#{payTime},'%Y-%c-%d %h:%i:%s'))
		
	</insert>
	<select id="selectVisitorsOrder" parameterType="long" resultType="map">
		select
			id,
			name,
			integra_price,
			price,
			real_price
		from
			visitors_order
		where
			id = #{id,jdbcType=NUMERIC}
	</select>
	<select id="selectMyAllVisitorsOrder" parameterType="long" resultType="map">
		select
			vo.id,
			DATE_FORMAT(vo.start_valid,'%Y-%m-%d %h:%i:%s') as start_valid,
			DATE_FORMAT(vo.end_valid,'%Y-%m-%d %h:%i:%s') as end_valid,
			v.head_img,
			vo.integra_price
		from 
			visitors_order vo join visitors v on vo.visitors_id = v.id
		where
			vo.user_id = #{userId}
	</select>
	
	<update id="updateStateMessage" parameterType="map">
		update visitors_order set pay_time = #{payTime},order_state=5 where user_id=#{userId}
	</update>
	<select id="selectVisitorsOrderDetail" parameterType="long" resultType="map">
		select
			vo.id,
			DATE_FORMAT(vo.start_valid,'%Y-%m-%d %h:%i:%s') as start_valid,
			DATE_FORMAT(vo.end_valid,'%Y-%m-%d %h:%i:%s') as start_valid,
			v.head_img,
			v.goods_type,
			vo.integra_price,
			vo.order_code,
			DATE_FORMAT(vo.create_time,'%Y-%m-%d %h:%i:%s') as create_time,
			DATE_FORMAT(vo.pay_time,'%Y-%m-%d %h:%i:%s') as pay_time,
			vo.pay_way,
			vo.real_price,
			ud.user_name,
			ud.telphone,
			ud.detail_address
		from 
			visitors_order vo left join visitors v on vo.visitors_id = v.id left join user_address ud on vo.address_id = ud.id
		where
			vo.id = #{id}
	</select>
	<select id="getPersonCount" parameterType="map" resultType="int">
		select
			sum(quantity)
		from
			visitors_order
		where 
			visitors_id = #{id} AND start_valid &lt;= DATE_FORMAT(#{start_valid},'%Y-%m-%d') AND end_valid &gt;= DATE_FORMAT(#{start_valid},'%Y-%m-%d')
	</select>
	
	
	<select id="selectOrderList" resultType="map" parameterType="map">
		select 
		o.id,
		o.name,
		o.order_describe,
		o.integra_price,
		DATE_FORMAT(o.start_valid,'%Y-%c-%d %h:%i:%s') as start_valid, 
		DATE_FORMAT(o.end_valid,'%Y-%c-%d %h:%i:%s') as end_valid,
		o.order_state,
		v.head_img,
		v.goods_type 
		from 
		visitors_order o join visitors v on o.visitors_id=v.id 
		where 
		o.user_id=#{userId} and o.type = 1 order by o.create_time
	</select>
	
	<select id="selectOrderList_count" resultType="int" parameterType="map">
		select 
		count(1) 
		from 
		visitors_order o join visitors v on o.visitors_id=v.id 
		where 
		o.user_id=#{userId} and o.type = 1 order by o.create_time
	</select>
	
	<select id="selectById" resultType="map" parameterType="int">
		select 
		o.id,
		o.name,
		o.order_describe,
		o.integra_price,
		DATE_FORMAT(o.start_valid,'%Y-%c-%d %h:%i:%s') as start_valid, 
		DATE_FORMAT(o.end_valid,'%Y-%c-%d %h:%i:%s') as end_valid,
		o.order_state,
		o.order_code,
		o.address_id,
		v.head_img,DATE_FORMAT(o.create_time,'%Y-%c-%d %h:%i:%s') as create_time, DATE_FORMAT(o.pay_time,'%Y-%c-%d %h:%i:%s') as pay_time,o.is_mention,o.real_price
		from 
		visitors_order o join visitors v on o.visitors_id=v.id 
		where 
		o.id=#{id} and o.type = 1 order by o.create_time
	</select>
	
	
</mapper>