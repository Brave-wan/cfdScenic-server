package com.htkj.cfdScenic.app.controller;

import com.htkj.cfdScenic.app.model.HtmlText;
import com.htkj.cfdScenic.app.model.ShopInformation;
import com.htkj.cfdScenic.app.service.HtmlTextService;
import com.htkj.cfdScenic.app.service.ShopInformationService;
import com.htrj.common.base.BaseController;
import com.htrj.common.exception.BusinessException;
import com.htrj.common.page.DataGrid;
import com.htrj.common.page.Json;
import com.htrj.common.page.PagerForm;
import com.htrj.common.utils.GenerateSequenceUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.ui.ModelMap;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.commons.CommonsMultipartFile;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;
import java.util.Map;

import static com.htkj.cfdScenic.app.controller.ImageController.imagePath;
import static com.htkj.cfdScenic.app.controller.ImageController.requestImgPath;

/**
 * @author wangfenglong
 * @date 2016/9/27 00279:36.
 */

@RequestMapping("/background/shopInformationManager")
@Controller
public class ShopInformationManageController extends BaseController {

    @Autowired
    private ShopInformationService shopInformationService;

    @Autowired
    private HtmlTextService htmlTextService;

    /**
     * 店铺信息主页面
     * @return
     */
    @RequestMapping("/toShopInformationManage")
    public String toShopInformationManage(){
        return "/background/shopInformation/Manager";
    }

    /**
     * 店铺信息-列表
     * @param page
     * @param shopInformation
     * @return
     */
    @RequestMapping("/getShopInformationList")
    @ResponseBody
    public DataGrid getShopInformationList(PagerForm page , ShopInformation shopInformation){
        return shopInformationService.getShopInformationList(page.getPageRequest(shopInformation.toMap()));
    }

    /**
     * 跳转到添加页面
     * @param model
     * @return
     */
    @RequestMapping("/toAddPage")
    public String toAddPage(ModelMap model){
        List<Map<String, Object>> list = shopInformationService.getType();
        model.put("list",list);
        return "/background/shopInformation/addPage";
    }

    /**
     * 公用上传方法
     * @param files
     */
    public String uploadImg( CommonsMultipartFile[] files){
        String imageURL = "";
        try {
            for(int i = 0;i<files.length;i++){
                System.out.println("fileName---------->" + files[i].getOriginalFilename());
                String newAddress = imagePath;
                if(!files[i].isEmpty()){
                    int pre = (int) System.currentTimeMillis();
                    File file1 = new File(newAddress);
                    //如果文件夹不存在则创建
                    if(!file1.exists()  && !file1.isDirectory()){
                        file1.mkdir();
                    }
                    //时间戳+文件名
                    String newName = new Date().getTime() + files[i].getOriginalFilename();
                    //上传的地址
                    String imgrul = newAddress+ "\\" + newName;
                    //存数据的地址
                    imageURL = requestImgPath +newName;
                    //拿到输出流，同时重命名上传的文件
                    FileOutputStream os = new FileOutputStream(imgrul);
                    //拿到上传文件的输入流
                    FileInputStream in = (FileInputStream) files[i].getInputStream();
                    //以写字节的方式写文件
                    int b = 0;
                    while((b=in.read()) != -1){
                        os.write(b);
                    }
                    os.flush();
                    os.close();
                    in.close();
                    int finaltime = (int) System.currentTimeMillis();
                    System.out.println(finaltime - pre);
                }
            }

        } catch (Exception e) {
        	e.printStackTrace();
        }
        return imageURL;
    }

    /**
     * 店铺信息 - 添加
     * @param files
     * @param shopInformation
     * @return
     */
    @RequestMapping("/addShopInformation")
    public String addShopInformation(@RequestParam("imageFile1") CommonsMultipartFile[] files1 ,
                                     @RequestParam("imageFile2") CommonsMultipartFile[] files2 ,
                                     @RequestParam("imageFile3") CommonsMultipartFile[] files3 ,
                                     @RequestParam("imageFile4") CommonsMultipartFile[] files4 ,
                                     @RequestParam("imageFile5") CommonsMultipartFile[] files5 ,
                                     @RequestParam("imageFile6") CommonsMultipartFile[] files6 ,
                                     @RequestParam("imageFile7") CommonsMultipartFile[] files7 ,
                                     @RequestParam("imageFile8") CommonsMultipartFile[] files8 ,
                                     @RequestParam("imageFile9") CommonsMultipartFile[] files9 ,ShopInformation shopInformation){

        String img1 = uploadImg(files1);
        String img2 = uploadImg(files2);
        String img3 = uploadImg(files3);
        String img4 = uploadImg(files4);
        String img5 = uploadImg(files5);
        String img6 = uploadImg(files6);
        String img7 = uploadImg(files7);
        String img8 = uploadImg(files8);
        String img9 = uploadImg(files9);
        try {
            if (img1 != null && "" != img1) {
                shopInformation.setHeadImg(img1);
            }  if (img2 != null && "" != img2) {
                shopInformation.setBackgroudImg(img2);
            }  if (img3 != null && "" != img3) {
                shopInformation.setHoldCardImg(img3);
            }  if (img4 != null && "" != img4) {
                shopInformation.setFaceCardImg(img4);
            }  if (img5 != null && "" != img5) {
                shopInformation.setBackCardImg(img5);
            }  if (img6 != null && "" != img6) {
                shopInformation.setLicenseImg(img6);
            }  if (img7 != null && "" != img7) {
                shopInformation.setOtherImg1(img7);
            }  if (img8 != null && "" != img8) {
                shopInformation.setOtherImg2(img8);
            }  if (img9 != null && "" != img9) {
                shopInformation.setShopImg(img9);
            }

            if(shopInformation.getId() != null && shopInformation.getId() != 0){
                shopInformationService.updateByPrimaryKeySelective(shopInformation);
            }else{
                shopInformation.setId(GenerateSequenceUtil.getUniqueId());
                shopInformation.setState(0);
                shopInformation.setCreateTime(new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date()));
                shopInformationService.insert(shopInformation);
            }
        } catch (IllegalStateException e) {
            e.printStackTrace();
            throw new BusinessException("图片上传失败-IllegalStateException",e);
        }

        return "redirect:/background/shopInformationManager/toShopInformationManage";
    }



    /**
     * 跳转到修改页面
     * @param id
     * @param model
     * @return
     */
    @RequestMapping("/toEditPage")
    public String toEditPage(Long id , Model model){
        try {
            Map<String, Object> shopInformation = shopInformationService.selectByPrimaryKey(id);
            HtmlText htmlText = htmlTextService.selectByPrimaryKey((Long) shopInformation.get("detail_id"));
            List<Map<String, Object>> list = shopInformationService.getType();
            model.addAttribute("list",list);
            model.addAttribute("model", shopInformation);
            model.addAttribute("htmlText",htmlText);
        } catch (Exception e) {
            e.printStackTrace();
        }
        return "/background/shopInformation/editPage";
    }

    /**
     * 跳转到详情页面
     * @param id
     * @param model
     * @return
     */
    @RequestMapping("/showPage")
    public String toShowPage(Long id , Model model){
        try {
            Map<String, Object> shopInformation = shopInformationService.selectByPrimaryKey(id);
            HtmlText htmlText = htmlTextService.selectByPrimaryKey((Long) shopInformation.get("detail_id"));
            List<Map<String, Object>> list = shopInformationService.getType();
            model.addAttribute("list",list);
            model.addAttribute("model", shopInformation);
            model.addAttribute("htmlText",htmlText);
        } catch (Exception e) {
            e.printStackTrace();
        }
        return "/background/shopInformation/showPage";
    }


    /**
     * Title: - 删除
     * @author wangfenglong
     * @date 2016年9月2日
     */
    @RequestMapping("/deleteShopInformation")
    @ResponseBody
    public Json deleteShopInformation(Long id){
        Json json = new Json();
        try {
            shopInformationService.deleteByPrimaryKey(id);
            json.setSuccess(true);
        } catch (Exception e) {
            e.printStackTrace();
        }
        return json;
    }


    @RequestMapping("/audit")
    @ResponseBody
    public Json audit(ShopInformation shopInformation) {
        Json json = new Json();
        try {
            if (shopInformation.getIsAudit() == 1) {
                shopInformation.setAuditFail("");
            }
            shopInformationService.audit(shopInformation);
            json.setSuccess(true);
        } catch (Exception e) {
        	e.printStackTrace();
            json.setSuccess(false);
        }
        return json;
    }

}
